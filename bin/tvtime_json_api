#!/usr/bin/ruby

require 'tvtime'
Encoding.default_external = 'UTF-8'

TVTime::Settings::create_default! unless TVTime::Settings::exists?

settings = TVTime::Settings.new

case ARGV[0]
when 'set_tvdb_api_key'
    settings[:tvdb_api_key] = ARGV[1]
when 'settings'
    puts settings.to_h.to_json
when 'search'
    search = TVTime::Search.new( settings )
    results = search.find_series( ARGV[1] )
    results = results.collect{|r| r.to_h }
    puts results.to_json
when 'add_series'
    search = TVTime::Search.new( settings )
    series = search.find_series_by_id( ARGV[1] )
    settings.add_series!( series ) if series
when 'remove_series'
    search = TVTime::Search.new( settings )
    series = search.find_series_by_id( ARGV[1] )
    settings.remove_series!( series.id ) if series
when 'episode_status'
    search = TVTime::Search.new( settings )
    library = TVTime::Library.new( settings )
    downloads = TVTime::Downloads.new( settings )
    files = []
    settings.each_series_episode_file_status( ARGV[1], search, downloads, library ) do | episode_file |
        files << episode_file.to_h
    end
    puts files.to_json
when 'download_missing'
    TVTime::download_missing_series!( ARGV[1], settings )
when 'catalog_and_downloads'
    downloads = TVTime::Downloads.new( settings )

    if( downloads.remove_completed_torrents! > 0 )
        TVTime::catalog_downloads!( settings, downloads )
    end

    files = []
    downloads.each_downloading_file do | episode_file |
        files << episode_file.to_h
    end
    files.sort!{|a,b| b[:percent_done] <=> a[:percent_done] } #highest percent first
    puts files.to_json
when 'catalog_downloads_for_series'
    TVTime::catalog_downloads_series!( ARGV[1], settings )
when 'catalog_downloads'
    TVTime::catalog_downloads!( settings )
end
