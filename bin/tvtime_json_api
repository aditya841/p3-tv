#!/usr/bin/ruby

require 'tvtime'

TVTime::Settings::create_default! unless TVTime::Settings::exists?

settings = TVTime::Settings.new

case ARGV[0]
when 'set_tvdb_api_key'
    settings.set[:tvdb_api_key] = ARGV[1]
    settings.save!
when 'series'
    puts settings[:series].to_json
when 'search'
    search = TVTime::Search.new( settings )
    results = search.find_series( ARGV[1] )
    results = results.collect{|r| r.to_h }
    puts results.to_json
when 'search_and_add'
    search = TVTime::Search.new( settings )
    series = search.find_series_by_id( ARGV[1] )
    settings.add_series!( series )
    settings.save!
when 'remove_series'
    search = TVTime::Search.new( settings )
    series = search.find_series_by_id( ARGV[1] )
    settings.remove_series!( series.id )
    settings.save!
when 'search_and_list'
    episodes = []
    search = TVTime::Search.new( settings )
    search.find_episodes_by_seriesid( ARGV[1] ) do | episode |
        episodes << episode.to_h
    end
    puts episodes.to_json
when 'episode_status'
    search = TVTime::Search.new( settings )
    library = TVTime::Library.new( settings )
    downloads = TVTime::Downloads.new( settings )
    files = []
    search.each_series_episode_file_status( ARGV[1], downloads, library ) do | episode_file |
        files << episode_file.to_h
    end
    puts files.to_json
when 'download_missing'
    TVTime::download_missing_series!( ARGV[1], settings )
when 'catalog_downloads'
    TVTime::catalog_downloads_series!( ARGV[1], settings )
end
